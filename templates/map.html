{% extends "base.html" %}

{% block title %}{{ table_name }} - Map View | CCT-Roan Project Beta{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <h1 class="hero-title">
        <i class="fas fa-map-marked-alt" style="color: var(--primary-teal);"></i> 
        {{ table_name }} Map View
    </h1>
    <p class="hero-subtitle">
        Explore {{ total_count }} spatial features on an interactive map
    </p>
</div>

<!-- Navigation Bar -->
<div class="search-section" style="padding: 1.5rem; margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <a href="/table/{{ table_name }}" class="btn-outline" style="text-decoration: none;">
                <i class="fas fa-table"></i> Table View
            </a>
            <a href="/" class="btn-outline" style="text-decoration: none;">
                <i class="fas fa-arrow-left"></i> Back to Overview
            </a>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            {% if filter_query and filter_type == 'search' %}
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(26, 188, 156, 0.1); border-radius: 6px; border: 1px solid var(--primary-teal);">
                <i class="fas fa-filter" style="color: var(--primary-teal);"></i>
                <span style="color: var(--dark-teal); font-weight: 500;">Filtered: "{{ filter_query }}"</span>
                <button id="toggle-filter-btn" class="btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-left: 0.5rem;">
                    <i class="fas fa-eye" id="filter-icon"></i> <span id="filter-text">Show All</span>
                </button>
            </div>
            {% endif %}
            <button id="fit-bounds-btn" class="btn-primary" style="border: none;">
                <i class="fas fa-expand-arrows-alt"></i> Fit All
            </button>
            <button id="toggle-layers" class="btn-outline" style="border: 2px solid var(--border-light);">
                <i class="fas fa-layer-group"></i> Layers
            </button>
        </div>
    </div>
</div>

<!-- Stats Section -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="data-card" style="text-align: center; padding: 1.5rem;">
        <div class="stat-item" style="flex-direction: column; gap: 0.5rem;">
            <i class="fas fa-database stat-icon" style="font-size: 2rem;"></i>
            <h3 style="color: var(--primary-teal); margin: 0; font-weight: 700;">{{ total_count }}</h3>
            <span style="color: var(--text-light); font-weight: 500;">Total Features</span>
        </div>
    </div>
    <div class="data-card" style="text-align: center; padding: 1.5rem;">
        <div class="stat-item" style="flex-direction: column; gap: 0.5rem;">
            <i class="fas fa-map stat-icon" style="font-size: 2rem;"></i>
            <h3 id="map-status" style="color: var(--accent-teal); margin: 0; font-weight: 700;">Loading...</h3>
            <span style="color: var(--text-light); font-weight: 500;">Map Status</span>
        </div>
    </div>
    <div class="data-card" style="text-align: center; padding: 1.5rem;">
        <div class="stat-item" style="flex-direction: column; gap: 0.5rem;">
            <i class="fas fa-globe stat-icon" style="font-size: 2rem;"></i>
            <h3 style="color: var(--dark-teal); margin: 0; font-weight: 700;">WGS 84</h3>
            <span style="color: var(--text-light); font-weight: 500;">Coordinate System</span>
        </div>
    </div>
</div>

<!-- Interactive Map -->
<div class="data-card" style="padding: 0; overflow: hidden;">
    <div style="background: var(--primary-teal); color: var(--white); padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
        <h4 style="margin: 0; font-weight: 600;">
            <i class="fas fa-globe"></i> Interactive Map
        </h4>
        <div style="display: flex; gap: 0.75rem;">
            <a href="/download/shapefile/{{ table_name }}" class="btn-outline" style="text-decoration: none; color: var(--white); border-color: rgba(255,255,255,0.3);">
                <i class="fas fa-download"></i> Shapefile
            </a>
            <a href="/api/geojson/{{ table_name }}" class="btn-outline" style="text-decoration: none; color: var(--white); border-color: rgba(255,255,255,0.3);" target="_blank">
                <i class="fas fa-code"></i> GeoJSON
            </a>
        </div>
    </div>
    <div style="height: 600px; width: 100%;">
        <div id="map" style="height: 100%; width: 100%; border-radius: 0 0 16px 16px;"></div>
    </div>
</div>

<!-- Feature Info Panel -->
<div class="data-card" id="feature-info" style="display: none; margin-top: 2rem;">
    <div class="card-header">
        <h4 class="card-title">
            <i class="fas fa-info-circle stat-icon"></i> Feature Information
        </h4>
    </div>
    <div style="margin-top: 1rem;">
        <div id="feature-details"></div>
    </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<!-- Google Maps API -->
<script
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"
    async defer></script>

<script>
    let map;

    function initMap() {
        // Initialize map
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 0, lng: 0 },
            zoom: 2,
            mapTypeId: 'roadmap', // Default map type
            mapTypeControl: false, // Disable default map type control
            streetViewControl: false // Disable street view
        });

        // Custom layer control
        const toggleLayersBtn = document.getElementById('toggle-layers');
        toggleLayersBtn.addEventListener('click', () => {
            const currentMapTypeId = map.getMapTypeId();
            if (currentMapTypeId === 'roadmap') {
                map.setMapTypeId('satellite');
                toggleLayersBtn.innerHTML = '<i class="fas fa-map"></i> Map View';
            } else {
                map.setMapTypeId('roadmap');
                toggleLayersBtn.innerHTML = '<i class="fas fa-layer-group"></i> Layers';
            }
        });

        // Filter parameters
        const filterQuery = '{{ filter_query | safe }}';
        const filterType = '{{ filter_type | safe }}';
        let isFiltered = filterType === 'search' && filterQuery !== '';

        // Function to load GeoJSON data
        function loadMapData(useFilter = isFiltered) {
            const apiUrl = useFilter && filterQuery ?
                `/api/geojson/{{ table_name }}/filtered?q=${encodeURIComponent(filterQuery)}` :
                `/api/geojson/{{ table_name }}`;

            // Clear existing data
            map.data.forEach(feature => {
                map.data.remove(feature);
            });

            document.getElementById('map-status').innerHTML = '<span class="text-warning">Loading...</span>';

            // Load GeoJSON data
            map.data.loadGeoJson(apiUrl, null, (features) => {
                if (features.length === 0) {
                    document.getElementById('map-status').innerHTML = '<span class="text-warning">No features found</span>';
                    return;
                }

                const statusText = useFilter ?
                    `<span class="text-success">Loaded ${features.length} filtered features</span>` :
                    `<span class="text-success">Loaded ${features.length} features</span>`;
                document.getElementById('map-status').innerHTML = statusText;

                // Fit map to data bounds
                const bounds = new google.maps.LatLngBounds();
                features.forEach(feature => {
                    processPoints(feature.getGeometry(), bounds.extend, bounds);
                });
                map.fitBounds(bounds);
            });
        }
        
        // Helper function to process geometries for bounds calculation
        function processPoints(geometry, callback, thisArg) {
            if (geometry instanceof google.maps.LatLng) {
                callback.call(thisArg, geometry);
            } else if (geometry instanceof google.maps.Data.Point) {
                callback.call(thisArg, geometry.get());
            } else {
                geometry.getArray().forEach(g => {
                    processPoints(g, callback, thisArg);
                });
            }
        }

        // Initial data load
        loadMapData();

        // Filter toggle button event handler
        const toggleFilterBtn = document.getElementById('toggle-filter-btn');
        if (toggleFilterBtn) {
            toggleFilterBtn.addEventListener('click', function() {
                isFiltered = !isFiltered;

                // Update button text and icon
                const filterIcon = document.getElementById('filter-icon');
                const filterText = document.getElementById('filter-text');
                
                if (isFiltered) {
                    filterIcon.className = 'fas fa-eye-slash';
                    filterText.textContent = 'Show All';
                } else {
                    filterIcon.className = 'fas fa-eye';
                    filterText.textContent = 'Show Filtered';
                }

                // Reload map data with new filter state
                loadMapData(isFiltered);
            });
        }
    
        // Fit bounds button
        document.getElementById('fit-bounds-btn').addEventListener('click', () => {
            const bounds = new google.maps.LatLngBounds();
            map.data.forEach(feature => {
                processPoints(feature.getGeometry(), bounds.extend, bounds);
            });
            map.fitBounds(bounds);
        });

        // Show feature information on click
        map.data.addListener('click', event => {
            showFeatureInfo(event.feature);
        });

        // Style features
        map.data.setStyle(feature => {
            const geomType = feature.getGeometry().getType();
            let style = {
                clickable: true,
                strokeColor: '#3388ff',
                strokeOpacity: 1,
                strokeWeight: 2,
                fillColor: '#3388ff',
                fillOpacity: 0.3
            };

            if (geomType === 'Point' || geomType === 'MultiPoint') {
                style.icon = {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 5,
                    fillColor: '#ff7800',
                    fillOpacity: 0.8,
                    strokeColor: '#000',
                    strokeWeight: 1
                };
            } else if (geomType === 'LineString' || geomType === 'MultiLineString') {
                style.strokeColor = '#ff7800';
                style.strokeOpacity = 0.8;
                style.strokeWeight = 3;
            }

            return style;
        });
    }

    function showFeatureInfo(feature) {
        const featureInfo = document.getElementById('feature-info');
        const featureDetails = document.getElementById('feature-details');
        
        let content = '<div class="row">';
        content += '<div class="col-md-6">';
        content += '<h6><i class="fas fa-shapes"></i> Geometry</h6>';
        content += `<p><strong>Type:</strong> ${feature.getGeometry().getType()}</p>`;
        
        content += '</div>';
        content += '<div class="col-md-6">';
        content += '<h6><i class="fas fa-tags"></i> Properties</h6>';
        
        const properties = {};
        feature.forEachProperty((value, key) => {
            properties[key] = value;
        });

        if (Object.keys(properties).length > 0) {
            for (const [key, value] of Object.entries(properties)) {
                if (value !== null && value !== undefined) {
                    content += `<p><strong>${key}:</strong> ${value}</p>`;
                }
            }
        } else {
            content += '<p class="text-muted">No properties available</p>';
        }
        
        content += '</div>';
        content += '</div>';
        
        featureDetails.innerHTML = content;
        featureInfo.style.display = 'block';
        
        // Scroll to feature info
        featureInfo.scrollIntoView({ behavior: 'smooth' });
    }

    // Assign initMap to window to make it accessible by Google Maps API callback
    window.initMap = initMap;
</script>

<style>
/* Custom styles for Google Maps integration */
#map {
    border-radius: 0 0 0.375rem 0.375rem;
}
</style>
{% endblock %}
