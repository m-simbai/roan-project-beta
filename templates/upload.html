{% extends "base.html" %}

{% block title %}Upload Shapefile - CCT-Roan Project Beta{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="hero-content">
        <h1><i class="fas fa-upload"></i> Upload Shapefile</h1>
        <p>Upload a ZIP file containing your shapefile to add it to the database</p>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Upload Form Card -->
            <div class="data-card">
                <div class="card-header">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Select Shapefile</h3>
                </div>
                
                <div style="padding: 2rem;">
                    <!-- Upload Form -->
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="shapefileInput" class="form-label" style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                                Choose ZIP File
                            </label>
                            <input type="file" 
                                   id="shapefileInput" 
                                   name="file" 
                                   accept=".zip" 
                                   class="form-control" 
                                   style="padding: 0.75rem; border: 2px dashed var(--light-teal); border-radius: 8px; background: rgba(26, 188, 156, 0.05);"
                                   required>
                            <small class="form-text text-muted" style="margin-top: 0.5rem; display: block;">
                                <i class="fas fa-info-circle"></i> Upload a ZIP file containing .shp, .shx, .dbf, and .prj files
                            </small>
                        </div>
                        
                        <!-- Upload Button -->
                        <div class="d-flex gap-3">
                            <button type="submit" 
                                    id="uploadBtn" 
                                    class="btn-primary" 
                                    style="flex: 1; padding: 0.75rem; font-weight: 600;">
                                <i class="fas fa-upload"></i> Upload Shapefile
                            </button>
                            <a href="/" class="btn-outline" style="padding: 0.75rem 1.5rem; text-decoration: none;">
                                <i class="fas fa-arrow-left"></i> Back
                            </a>
                        </div>
                    </form>
                    
                    <!-- Progress Bar -->
                    <div id="progressContainer" style="display: none; margin-top: 2rem;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span style="font-weight: 600; color: var(--dark-teal);">
                                <i class="fas fa-spinner fa-spin"></i> Processing...
                            </span>
                            <span id="progressText" style="color: var(--text-secondary);">0%</span>
                        </div>
                        <div class="progress" style="height: 8px; background: var(--bg-light); border-radius: 4px; overflow: hidden;">
                            <div id="progressBar" 
                                 class="progress-bar" 
                                 style="width: 0%; background: linear-gradient(90deg, var(--primary-teal), var(--accent-teal)); transition: width 0.3s ease;">
                            </div>
                        </div>
                        <div id="progressMessage" style="margin-top: 1rem; padding: 1rem; background: rgba(26, 188, 156, 0.1); border-radius: 8px; display: none;">
                            <i class="fas fa-info-circle" style="color: var(--primary-teal);"></i>
                            <span style="margin-left: 0.5rem; color: var(--dark-teal);"></span>
                        </div>
                    </div>
                    
                    <!-- Success/Error Messages -->
                    <div id="alertContainer" style="margin-top: 2rem;"></div>
                </div>
            </div>
            
            <!-- Upload Instructions Card -->
            <div class="data-card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h4><i class="fas fa-question-circle"></i> Upload Instructions</h4>
                </div>
                
                <div style="padding: 1.5rem;">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 style="color: var(--dark-teal); font-weight: 600; margin-bottom: 1rem;">
                                <i class="fas fa-check-circle"></i> Required Files
                            </h6>
                            <ul style="list-style: none; padding: 0;">
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-file" style="color: var(--primary-teal); margin-right: 0.5rem;"></i> .shp (geometry)</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-file" style="color: var(--primary-teal); margin-right: 0.5rem;"></i> .shx (index)</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-file" style="color: var(--primary-teal); margin-right: 0.5rem;"></i> .dbf (attributes)</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-file" style="color: var(--primary-teal); margin-right: 0.5rem;"></i> .prj (projection)</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 style="color: var(--dark-teal); font-weight: 600; margin-bottom: 1rem;">
                                <i class="fas fa-info-circle"></i> Guidelines
                            </h6>
                            <ul style="list-style: none; padding: 0;">
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-arrow-right" style="color: var(--accent-teal); margin-right: 0.5rem;"></i> Maximum file size: 100MB</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-arrow-right" style="color: var(--accent-teal); margin-right: 0.5rem;"></i> Only ZIP format accepted</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-arrow-right" style="color: var(--accent-teal); margin-right: 0.5rem;"></i> One shapefile per ZIP</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-arrow-right" style="color: var(--accent-teal); margin-right: 0.5rem;"></i> Table names auto-generated</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('shapefileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressMessage = document.getElementById('progressMessage');
    const alertContainer = document.getElementById('alertContainer');
    
    // Clear previous messages
    alertContainer.innerHTML = '';
    
    // Validate file selection
    if (!fileInput.files || fileInput.files.length === 0) {
        showAlert('Please select a ZIP file to upload.', 'error');
        return;
    }
    
    const file = fileInput.files[0];
    
    // Validate file type
    if (!file.name.toLowerCase().endsWith('.zip')) {
        showAlert('Please select a ZIP file.', 'error');
        return;
    }
    
    // Validate file size (100MB)
    if (file.size > 100 * 1024 * 1024) {
        showAlert('File size must be less than 100MB.', 'error');
        return;
    }
    
    // Prepare form data
    const formData = new FormData();
    formData.append('file', file);
    
    // Show progress
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    progressContainer.style.display = 'block';
    
    // Simulate progress for upload
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        
        progressBar.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
        
        if (progress < 30) {
            showProgressMessage('Uploading file...');
        } else if (progress < 60) {
            showProgressMessage('Extracting shapefile...');
        } else if (progress < 90) {
            showProgressMessage('Importing to database...');
        }
    }, 200);
    
    // Upload file
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        
        // Complete progress
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        
        if (data.success) {
            showProgressMessage(`Successfully imported ${data.record_count} features!`);
            showAlert(
                `<strong>Success!</strong> Shapefile imported as table "<strong>${data.table_name}</strong>" with ${data.record_count} features.`,
                'success'
            );
            
            // Reset form after delay
            setTimeout(() => {
                fileInput.value = '';
                progressContainer.style.display = 'none';
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Shapefile';
            }, 3000);
        } else {
            showAlert(`<strong>Upload failed:</strong> ${data.error}`, 'error');
            resetForm();
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        showAlert(`<strong>Upload failed:</strong> ${error.message}`, 'error');
        resetForm();
    });
    
    function showProgressMessage(message) {
        progressMessage.style.display = 'block';
        progressMessage.querySelector('span').textContent = message;
    }
    
    function showAlert(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
        
        alertContainer.innerHTML = `
            <div class="alert ${alertClass}" style="padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: none; background: ${type === 'success' ? 'rgba(26, 188, 156, 0.1)' : 'rgba(231, 76, 60, 0.1)'}; color: ${type === 'success' ? 'var(--dark-teal)' : '#c0392b'};">
                <i class="${icon}" style="margin-right: 0.5rem;"></i>
                ${message}
            </div>
        `;
    }
    
    function resetForm() {
        progressContainer.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Shapefile';
    }
});
</script>
{% endblock %}
